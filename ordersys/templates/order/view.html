{% extends 'base.html' %}

{% block header %}
<h1>{% block title %}订单详细 {{order['id']}}{% endblock %}</h1>
<a class="action" href="{{ url_for('order.index') }}">我的订单</a>
{% if g.user['is_admin'] %}
<a class="action" href="{{ url_for('order.all') }}">所有订单</a>
{% endif %}
{% endblock %}

{% block content %}
{% for course in courses %}
<article class="course_container">
  <div class="course_icon_container">
    <img src="/static/menuicons/{{ course.icon_hashname }}" class="preview_icon" />
  </div>
  <div class="course_body_container">
    <div class="course_title_line">
      <h1 class="course_title">{{ course['title'] }}</h1>
      <span>{{ course['price'] }} * {{ course['quantity'] }} 元</span>
    </div>
    <p class="course_description">{{ course['description'] }}</p>
  </div>
</article>
{% endfor %}

<article class="order_summary">
  <span>共 {{ order.price }} 元</span>
</article>


<article class="order_summary">
  {% if order['status'] == 'new' %}
  <a href="/order/{{order['id']}}/eito">选择配送方式</a>
  {% elif order['table_no'] %}
  <span>堂食：桌号<{{order['table_no']}}></span>
  {% else %}
  <span>配送至：{{order['take_out_address']}}，电话：{{order['take_out_phone_no']}}</span>  
  {% endif %}
</article>

{% if g.user['is_admin'] %}
<article class="order_summary">
  <select class="orderfilter" id="orderfilter">
    <option id="new" value="new"
            {% if order['status'] == 'new' %}
            selected
            {% endif %}>
      未选择配送方式的订单</option>
    <option id="confirmed" value="confirmed"
            {% if order['status'] == 'confirmed' %}
            selected
            {% endif %}>
      已选择配送方式的订单</option>
    <option id="cancelled" value="cancelled"
            {% if order['status'] == 'cancelled' %}
            selected
            {% endif %}>
      已取消订单</option>
    <option id="finished" value="finished"
            {% if order['status'] == 'finished' %}
            selected
            {% endif %}>
      已完成订单</option>
  </select>
</article>

<script src="{{ url_for('static', filename='jquery.js') }}"></script>
<script>
  $(document).ready(function() {
    var filter = $('#orderfilter');
    filter.change(function () {
      var val = $('#orderfilter option:selected').attr('value');
      var id = window.location.pathname.split('/')[2];

      $.ajax({
        url: '/order/' + id + '/update_status',
        type: 'POST',
        data: JSON.stringify({ status: val }),
        contentType: "application/json",
        success: function(data, textStatus, jqXHR) {
          // nothing
        },
        error: function(jqXHR, textStatus, errorThrown) {
          alert('请重试!');          
        },
      });
    });
  });
</script>
{% endif %}

{% endblock %}
